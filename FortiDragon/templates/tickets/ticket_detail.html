{% extends "base.html" %}

{% block title %}Ticket #{{ ticket.id }}{% endblock %}

{% block content %}
  <h2 class="mb-3">
    Ticket #{{ ticket.id }} – {{ ticket.title }}
  </h2>

  {# Admin/tech actions: approve / assign #}
  {% if user.is_staff or perms.tickets.can_assign_ticket or perms.tickets.can_approve_ticket %}
    <div class="mb-3 d-flex flex-wrap gap-2">

      {# Approve button (only if user can approve and ticket is pending) #}
      {% if perms.tickets.can_approve_ticket and ticket.status == ticket.Status.PENDING %}
        <form method="post" action="{% url 'tickets:approve' ticket.id %}">
          {% csrf_token %}
          <button type="submit" class="btn btn-sm btn-success">
            Approve
          </button>
        </form>
      {% endif %}

      {# Assign to any technician/admin (dropdown form page) #}
      {% if user.is_staff or perms.tickets.can_assign_ticket %}
        <a href="{% url 'tickets:assign' ticket.id %}"
           class="btn btn-sm btn-outline-primary">
          Assign to technician/admin
        </a>
      {% endif %}

      {# Quick self-assign #}
      {% if perms.tickets.can_assign_ticket %}
        <form method="post" action="{% url 'tickets:assign_to_me' ticket.id %}">
          {% csrf_token %}
          <button type="submit" class="btn btn-sm btn-outline-secondary">
            Assign to me
          </button>
        </form>
      {% endif %}
    </div>
  {% endif %}

  <table class="table table-bordered table-sm">
    <tbody>
      <tr>
        <th scope="row">Status</th>
        <td>{{ ticket.get_status_display }}</td>
      </tr>
      <tr>
        <th scope="row">Priority</th>
        <td>{{ ticket.get_priority_display }}</td>
      </tr>
      <tr>
        <th scope="row">Created By</th>
        <td>{{ ticket.created_by|default:"—" }}</td>
      </tr>
      <tr>
        <th scope="row">Assigned To</th>
        <td>{{ ticket.assigned_to|default:"Unassigned" }}</td>
      </tr>
      <tr>
        <th scope="row">Approved By</th>
        <td>{{ ticket.approved_by|default:"—" }}</td>
      </tr>
      <tr>
        <th scope="row">Created At</th>
        <td>{{ ticket.created_at|date:"Y-m-d H:i" }}</td>
      </tr>
      <tr>
        <th scope="row">Last Updated</th>
        <td>{{ ticket.updated_at|date:"Y-m-d H:i" }}</td>
      </tr>
      <tr>
        <th scope="row">Description</th>
        <td style="white-space: pre-wrap;">{{ ticket.description }}</td>
      </tr>
    </tbody>
  </table>

  <p class="mt-3">
    <a href="{% url 'tickets:dashboard' %}" class="btn btn-secondary btn-sm">
      &larr; Back to Dashboard
    </a>
    <a href="{% url 'tickets:pending' %}" class="btn btn-link btn-sm">
      View Pending Tickets
    </a>
  </p>
{% endblock %}